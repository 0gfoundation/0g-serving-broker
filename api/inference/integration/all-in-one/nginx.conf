events { }

http {
    # Unified ZK service cluster with load balancing
    upstream zk_cluster {
        # Round-robin load balancing between all zk service instances
        server zk-service-1:3001;
        server zk-service-2:3002;
        server zk-service-3:3003;
    }

    # ZK service proxy on port 3001 for backward compatibility - container access only
    server {
        listen 3001;
        
        location / {
            # Only allow access from Docker containers (internal network)
            allow 172.16.0.0/12;    # Docker default bridge networks
            allow 10.0.0.0/8;       # Docker custom networks
            allow 192.168.0.0/16;   # Docker custom networks
            deny all;
            
            proxy_pass http://zk_cluster;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Connection pooling and keep-alive
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            
            # Timeout settings for slow ZK operations
            proxy_connect_timeout 60s;
            proxy_send_timeout 120s;
            proxy_read_timeout 120s;
        }
    }

    server {
        listen 80;
        
        # Use Docker's DNS resolver with valid parameter for caching
        resolver 127.0.0.11 valid=30s;
        
        # Use variables to enable dynamic resolution
        set $broker_backend 0g-serving-provider-broker:3080;

        location /v1/proxy {
            proxy_pass http://$broker_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /v1/quote {
            proxy_pass http://$broker_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # Unified ZK service routing with load balancing - container access only
        location /zk/ {
            # Only allow access from Docker containers (internal network)
            allow 172.16.0.0/12;    # Docker default bridge networks
            allow 10.0.0.0/8;       # Docker custom networks
            allow 192.168.0.0/16;   # Docker custom networks
            deny all;
            
            proxy_pass http://zk_cluster/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Connection pooling and keep-alive
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            
            # Timeout settings for slow ZK operations
            proxy_connect_timeout 60s;
            proxy_send_timeout 120s;
            proxy_read_timeout 120s;
        }

        location / {
            allow 127.0.0.1;
            allow 172.16.0.0/12;
            deny all;
            proxy_pass http://$broker_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /stub_status {
            stub_status on;
        }
    }
}
